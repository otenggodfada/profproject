<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Books</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script type="module" src="./navbar.js"></script>
    <script type="module" src="./dynamiccon.js"></script>
    <script src="bottomnv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"
      rel="stylesheet"
    />
    <style>
      .pdf-protection {
        position: relative;
        overflow: hidden;
      }
      .pdf-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        pointer-events: none;
        z-index: 1000;
      }
      .watermark {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 48px;
        color: rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        pointer-events: none;
        z-index: 1000;
        user-select: none;
      }
      @media print {
        body * {
          display: none !important;
        }
        .pdf-protection,
        .pdf-protection * {
          display: block !important;
        }
        .watermark {
          display: block !important;
          color: rgba(0, 0, 0, 0.3) !important;
        }
      }
      #pdfContainer {
        width: 100%;
        height: calc(100vh - 48px);
        overflow: auto;
        background: #525659;
      }

      #pdfViewer {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .page-container {
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        background: white;
      }

      .pdf-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 20px;
        display: flex;
        gap: 15px;
        z-index: 1000;
      }

      .pdf-controls button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background 0.3s;
      }

      .pdf-controls button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .pdf-page-info {
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white p-5 flex flex-col items-center">
    <div
      id="loadingScreen"
      class="fixed inset-0 flex items-center justify-center z-50"
    >
      <div
        class="loader border-t-4 border-blue-500 border-solid rounded-full w-16 h-16 animate-spin"
      ></div>
    </div>

    <div class="fixed top-0 bg-[#172554] z-20 w-full border-b">
      <div id="navbar-container"></div>
    </div>

    <!-- Book Search and Filter -->
    <div class="max-w-7xl w-full mt-28 mb-6">
      <div
        class="flex flex-col md:flex-row gap-4 items-center justify-between bg-gray-800 p-4 rounded-lg"
      >
        <div class="relative w-full md:w-96">
          <input
            type="text"
            id="searchInput"
            placeholder="Search your books..."
            class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
        </div>
        <div class="flex gap-4">
          <select
            id="sortSelect"
            class="bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="title">Title A-Z</option>
          </select>
        </div>
      </div>
    </div>

    <div class="max-w-7xl w-full py-2 mb-28 rounded-lg">
      <div
        id="booksContainer"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
    </div>

    <!-- Enhanced Modal for PDF Viewer -->
    <div
      id="pdfModal"
      class="hidden fixed z-50 inset-0 bg-black bg-opacity-90 flex items-center justify-center"
    >
      <div
        class="bg-gray-800 w-full h-full rounded-lg relative shadow-lg pdf-protection"
      >
        <div
          class="absolute top-0 left-0 right-0 bg-gray-800 p-3 flex justify-between items-center z-20"
        >
          <div class="flex items-center space-x-4">
            <button
              id="zoomOut"
              class="text-white hover:text-blue-400 transition"
            >
              <i class="fas fa-search-minus"></i>
            </button>
            <button
              id="zoomIn"
              class="text-white hover:text-blue-400 transition"
            >
              <i class="fas fa-search-plus"></i>
            </button>
          </div>
          <button
            id="closeModal"
            class="text-white hover:text-red-500 transition"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="watermark"></div>
        <div id="pdfContainer">
          <div id="pdfViewer"></div>
        </div>
        <div class="pdf-controls">
          <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
          <div class="pdf-page-info">
            Page <span id="currentPage">0</span> of
            <span id="totalPages">0</span>
          </div>
          <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>

    <script>
      window.onload = () => {
        const firebaseConfig = {
          apiKey: "AIzaSyCtaftgrL4p4wqNC2w211mUi8amkjw2kzM",
          authDomain: "profstudymate-6d0fc.firebaseapp.com",
          projectId: "profstudymate",
          storageBucket: "profstudymate.appspot.com",
          messagingSenderId: "141453158869",
          appId: "1:141453158869:web:d4ded426a90e9937e2f55c",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let allBooks = [];

        // Initialize UI elements
        const pdfModal = document.getElementById("pdfModal");
        const pdfViewer = document.getElementById("pdfViewer");
        const closeModal = document.getElementById("closeModal");
        const searchInput = document.getElementById("searchInput");
        const sortSelect = document.getElementById("sortSelect");
        const zoomIn = document.getElementById("zoomIn");
        const zoomOut = document.getElementById("zoomOut");

        // Add event listeners for search and sort
        searchInput.addEventListener("input", filterBooks);
        sortSelect.addEventListener("change", filterBooks);

        function filterBooks() {
          const searchTerm = searchInput.value.toLowerCase();
          const sortOption = sortSelect.value;

          let filteredBooks = allBooks.filter(
            (book) =>
              book.title.toLowerCase().includes(searchTerm) ||
              book.description.toLowerCase().includes(searchTerm)
          );

          // Apply sorting
          filteredBooks.sort((a, b) => {
            switch (sortOption) {
              case "newest":
                return b.timestamp - a.timestamp;
              case "oldest":
                return a.timestamp - b.timestamp;
              case "title":
                return a.title.localeCompare(b.title);
              default:
                return 0;
            }
          });

          renderBooks(filteredBooks);
        }

        function renderBooks(books) {
          const booksContainer = document.getElementById("booksContainer");
          booksContainer.innerHTML = "";

          books.forEach((book) => {
            const bookCard = createBookCard(book);
            booksContainer.appendChild(bookCard);
          });
        }

        function createBookCard(book) {
          const { title, description, image_url, pdf_url } = book;
          // Update Google Drive URL handling
          const fileIdMatch = pdf_url.match(/\/d\/([^/]+)/);
          const fileId = fileIdMatch ? fileIdMatch[1] : null;

          const bookCard = document.createElement("div");
          bookCard.className =
            "bg-gray-800 rounded-xl overflow-hidden shadow-lg transform transition duration-300 hover:scale-105 hover:shadow-blue-500/20 border border-gray-700";
          bookCard.innerHTML = `
            <div class="relative group">
              <img src="${image_url}" alt="${title}" class="w-full h-48 object-cover transition duration-300 group-hover:opacity-75">
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </div>
            <div class="p-6 space-y-4">
              <h2 class="text-xl font-bold text-white line-clamp-2">${title}</h2>
              <p class="text-gray-400 text-sm line-clamp-3">${description}</p>
              <button class="w-full flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300"
                onclick="openPdf('${pdf_url}', '${title}', '${fileId}')">
                <i class="fas fa-book-reader"></i>
                <span>Read Book</span>
              </button>
            </div>
          `;
          return bookCard;
        }

        firebase.auth().onAuthStateChanged(async (user) => {
          const booksContainer = document.getElementById("booksContainer");
          if (!user) {
            booksContainer.innerHTML =
              "<p class='text-center text-red-500 font-semibold'>Please log in to view your books.</p>";
            return;
          }

          try {
            const myBooksSnapshot = await db
              .collection("Mybooks")
              .doc(user.uid)
              .collection("books")
              .get();

            if (myBooksSnapshot.empty) {
              booksContainer.innerHTML =
                "<p class='text-center text-gray-400 font-semibold'>No books found.</p>";
              return;
            }

            const bookPromises = myBooksSnapshot.docs.map(async (doc) => {
              const bookDoc = await db.collection("books").doc(doc.id).get();
              return bookDoc.exists
                ? {
                    id: doc.id,
                    ...bookDoc.data(),
                    timestamp: doc.data().timestamp?.toMillis() || 0,
                  }
                : null;
            });

            allBooks = (await Promise.all(bookPromises)).filter(
              (book) => book !== null
            );
            filterBooks(); // Initial render with all books
            document.getElementById("loadingScreen").classList.add("hidden");
          } catch (error) {
            console.error("Error fetching books:", error);
            booksContainer.innerHTML =
              "<p class='text-center text-red-500 font-semibold'>Failed to load books.</p>";
          }
        });

        // Enhanced PDF viewer functionality
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.5;
        const viewer = document.getElementById("pdfViewer");
        const container = document.getElementById("pdfContainer");

        async function renderPage(num) {
          const page = await pdfDoc.getPage(num);
          const viewport = page.getViewport({ scale });

          // Create canvas for this page
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          // Create container for the page
          const pageContainer = document.createElement("div");
          pageContainer.className = "page-container";
          pageContainer.appendChild(canvas);

          // Add watermark to each page
          const watermark = document.createElement("div");
          watermark.className = "watermark";
          watermark.style.position = "absolute";
          watermark.style.opacity = "0.1";
          watermark.textContent = `${
            firebase.auth().currentUser.email
          } - ${new Date().toLocaleDateString()}`;
          pageContainer.appendChild(watermark);

          // Render PDF page
          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };

          await page.render(renderContext);
          viewer.appendChild(pageContainer);
        }

        window.openPdf = async (url, title, fileId) => {
          try {
            const pdfModal = document.getElementById("pdfModal");
            viewer.innerHTML = ""; // Clear previous PDF
            pdfModal.classList.remove("hidden");

            // Show loading state
            viewer.innerHTML = `
              <div class="flex items-center justify-center w-full h-full">
                <div class="text-white">
                  <div class="loader border-t-4 border-blue-500 border-solid rounded-full w-12 h-12 animate-spin mb-4 mx-auto"></div>
                  <p>Loading PDF...</p>
                </div>
              </div>
            `;

            // Handle Google Drive URLs
            let pdfUrl = url;
            if (fileId) {
              // Try different Google Drive URL formats
              const urls = [
                `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                `https://drive.google.com/uc?export=download&id=${fileId}`,
                `https://drive.google.com/file/d/${fileId}/preview`,
              ];

              for (const testUrl of urls) {
                try {
                  const response = await fetch(testUrl, {
                    method: "HEAD",
                    mode: "cors",
                  });
                  if (response.ok) {
                    pdfUrl = testUrl;
                    break;
                  }
                } catch (error) {
                  console.log("Trying alternative URL format...");
                }
              }

              // If direct access fails, show alternate viewing options
              if (pdfUrl === url) {
                viewer.innerHTML = `
                  <div class="flex items-center justify-center w-full h-full">
                    <div class="text-white text-center max-w-lg p-6">
                      <i class="fas fa-exclamation-circle text-4xl text-yellow-500 mb-4"></i>
                      <h3 class="text-xl font-bold mb-4">PDF Viewer Options</h3>
                      <p class="mb-6">Due to Google Drive security settings, we cannot display the PDF directly. Please choose an option below:</p>
                      <div class="space-y-4">
                        <a href="https://drive.google.com/file/d/${fileId}/view" target="_blank" 
                           class="block w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                          <i class="fab fa-google-drive mr-2"></i>Open in Google Drive
                        </a>
                        <a href="https://drive.google.com/uc?export=download&id=${fileId}" 
                           class="block w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                          <i class="fas fa-download mr-2"></i>Download PDF
                        </a>
                      </div>
                    </div>
                  </div>
                `;
                return;
              }
            }

            // Load and render PDF with retry mechanism
            let retryCount = 0;
            const maxRetries = 3;

            async function loadPDF() {
              try {
                const loadingTask = pdfjsLib.getDocument({
                  url: pdfUrl,
                  withCredentials: false, // Changed to false for Google Drive URLs
                  cMapUrl:
                    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/",
                  cMapPacked: true,
                });

                loadingTask.onProgress = (data) => {
                  if (data.total > 0) {
                    const progress = ((data.loaded / data.total) * 100).toFixed(
                      0
                    );
                    viewer.innerHTML = `
                      <div class="flex items-center justify-center w-full h-full">
                        <div class="text-white text-center">
                          <div class="loader border-t-4 border-blue-500 border-solid rounded-full w-12 h-12 animate-spin mb-4"></div>
                          <p>Loading PDF... ${progress}%</p>
                        </div>
                      </div>
                    `;
                  }
                };

                pdfDoc = await loadingTask.promise;
                viewer.innerHTML = "";

                // Update UI
                document.getElementById("totalPages").textContent =
                  pdfDoc.numPages;
                document.getElementById("currentPage").textContent = "1";

                // Render first few pages
                for (let i = 1; i <= Math.min(3, pdfDoc.numPages); i++) {
                  await renderPage(i);
                }

                // Setup infinite scroll
                let lastRenderedPage = 3;
                container.onscroll = async () => {
                  if (
                    container.scrollTop + container.clientHeight >=
                    container.scrollHeight - 500
                  ) {
                    if (lastRenderedPage < pdfDoc.numPages) {
                      lastRenderedPage++;
                      await renderPage(lastRenderedPage);
                      document.getElementById("currentPage").textContent =
                        lastRenderedPage;
                    }
                  }
                };
              } catch (error) {
                console.error("PDF loading error:", error);
                if (retryCount < maxRetries) {
                  retryCount++;
                  console.log(
                    `Retrying PDF load (attempt ${retryCount}/${maxRetries})...`
                  );
                  await new Promise((resolve) =>
                    setTimeout(resolve, 1000 * retryCount)
                  );
                  return loadPDF();
                }

                // If all attempts fail, show error with options
                viewer.innerHTML = `
                  <div class="flex items-center justify-center w-full h-full">
                    <div class="text-white text-center max-w-lg p-6">
                      <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                      <h3 class="text-xl font-bold mb-4">Unable to Load PDF</h3>
                      <p class="mb-6">We couldn't load the PDF directly. Please try one of these options:</p>
                      <div class="space-y-4">
                        ${
                          fileId
                            ? `
                          <a href="https://drive.google.com/file/d/${fileId}/view" target="_blank" 
                             class="block w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="fab fa-google-drive mr-2"></i>Open in Google Drive
                          </a>
                          <a href="https://drive.google.com/uc?export=download&id=${fileId}" 
                             class="block w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                            <i class="fas fa-download mr-2"></i>Download PDF
                          </a>
                        `
                            : `
                          <a href="${url}" target="_blank" 
                             class="block w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-external-link-alt mr-2"></i>Open PDF in New Tab
                          </a>
                        `
                        }
                        <button onclick="location.reload()" 
                                class="block w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-300">
                          <i class="fas fa-redo mr-2"></i>Retry
                        </button>
                      </div>
                    </div>
                  </div>
                `;
              }
            }

            await loadPDF();
          } catch (error) {
            console.error("Error in openPdf:", error);
            viewer.innerHTML = `
              <div class="flex items-center justify-center w-full h-full">
                <div class="text-white text-center">
                  <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                  <p class="text-red-500">Unable to load the PDF. Please try again later.</p>
                  <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Retry
                  </button>
                </div>
              </div>
            `;
          }
        };

        document.getElementById("prevPage").onclick = () => {
          if (container.firstElementChild) {
            container.scrollTo({
              top: container.scrollTop - container.clientHeight,
              behavior: "smooth",
            });
          }
        };

        document.getElementById("nextPage").onclick = () => {
          if (container.lastElementChild) {
            container.scrollTo({
              top: container.scrollTop + container.clientHeight,
              behavior: "smooth",
            });
          }
        };

        document.getElementById("zoomIn").onclick = async () => {
          scale *= 1.2;
          viewer.innerHTML = "";
          lastRenderedPage = 0;
          container.scrollTop = 0;
          for (let i = 1; i <= Math.min(3, pdfDoc.numPages); i++) {
            await renderPage(i);
          }
        };

        document.getElementById("zoomOut").onclick = async () => {
          scale /= 1.2;
          viewer.innerHTML = "";
          lastRenderedPage = 0;
          container.scrollTop = 0;
          for (let i = 1; i <= Math.min(3, pdfDoc.numPages); i++) {
            await renderPage(i);
          }
        };

        document.getElementById("closeModal").onclick = () => {
          pdfModal.classList.add("hidden");
          viewer.innerHTML = "";
          pdfDoc = null;
        };

        container.addEventListener("contextmenu", (e) => e.preventDefault());
        container.addEventListener("selectstart", (e) => e.preventDefault());
        container.addEventListener("copy", (e) => e.preventDefault());
        container.addEventListener("dragstart", (e) => e.preventDefault());

        document.addEventListener("keydown", (e) => {
          if (
            (e.ctrlKey && ["p", "P", "s", "S"].includes(e.key)) ||
            e.key === "PrintScreen" ||
            (e.altKey && e.key === "PrintScreen")
          ) {
            e.preventDefault();
            return false;
          }
        });
      };
    </script>
  </body>
</html>
