<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script type="module" src="./navbar.js"></script>
    <script type="module" src="./dynamiccon.js"></script>
    <script src="bottomnv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"
      rel="stylesheet"
    />
    <style>
      .pdf-protection {
        position: relative;
        overflow: hidden;
      }
      .pdf-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        pointer-events: none;
        z-index: 1000;
      }
      .watermark {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 48px;
        color: rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        pointer-events: none;
        z-index: 1000;
        user-select: none;
      }
      @media print {
        body * {
          display: none !important;
        }
        .pdf-protection,
        .pdf-protection * {
          display: block !important;
        }
        .watermark {
          display: block !important;
          color: rgba(0, 0, 0, 0.3) !important;
        }
      }
      #pdfContainer {
        width: 100%;
        height: calc(100vh - 48px);
        overflow: auto;
        background: #525659;
      }

      #pdfViewer {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .page-container {
        position: relative;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        background: white;
      }

      .pdf-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 20px;
        display: flex;
        gap: 15px;
        z-index: 1000;
      }

      .pdf-controls button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background 0.3s;
      }

      .pdf-controls button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .pdf-page-info {
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      /* Search highlighting styles */
      .search-highlight {
        background-color: yellow;
        opacity: 0.7;
        position: absolute;
        z-index: 10;
      }
      
      .search-highlight.active {
        background-color: orange;
        opacity: 0.9;
      }
      
      /* Input focus styles */
      #searchInput:focus, #gotoPageInput:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
      
      /* Enhanced PDF viewer styles */
      #pdfjsViewer {
        background: #525659;
      }
      
      /* Thumbnails styles */
      .thumbnail-item {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        background: white;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .thumbnail-item:hover {
        border-color: #3b82f6;
        transform: scale(1.02);
      }
      
      .thumbnail-item.active {
        border-color: #3b82f6;
        background: #dbeafe;
      }
      
      .thumbnail-item img {
        width: 100%;
        height: auto;
        display: block;
      }
      
      .thumbnail-item .page-number {
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
      }
      
      /* Outline styles */
      .outline-item {
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 4px;
        transition: background 0.2s ease;
        color: #e5e7eb;
        font-size: 14px;
      }
      
      .outline-item:hover {
        background: rgba(59, 130, 246, 0.1);
      }
      
      .outline-item.active {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
      }
      
      .outline-item .outline-level-1 { padding-left: 0; }
      .outline-item .outline-level-2 { padding-left: 16px; }
      .outline-item .outline-level-3 { padding-left: 32px; }
      .outline-item .outline-level-4 { padding-left: 48px; }
      
      /* Sidebar toggle animations */
      #leftSidebar, #reviewsSidebar {
        transition: transform 0.3s ease, width 0.3s ease;
      }
      
      /* PDF.js viewer integration */
      .pdfjs-viewer {
        background: #525659;
        color: #fff;
      }
      
      .pdfjs-viewer .toolbar {
        background: #374151;
        border-bottom: 1px solid #4b5563;
      }
      
      .pdfjs-viewer .toolbarButton {
        background: transparent;
        border: none;
        color: #e5e7eb;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s ease;
      }
      
      .pdfjs-viewer .toolbarButton:hover {
        background: rgba(59, 130, 246, 0.1);
      }
      
      .pdfjs-viewer .toolbarButton.toggled {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
      }
      
      /* Loading states */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Responsive design */
      @media (max-width: 768px) {
        #leftSidebar, #reviewsSidebar {
          width: 100%;
          max-width: 300px;
        }
        
        .pdf-controls {
          bottom: 10px;
          padding: 8px 16px;
          gap: 10px;
        }
        
        .pdf-page-info {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white p-5 flex flex-col items-center">
    <div
      id="loadingScreen"
      class="fixed inset-0 flex items-center justify-center z-50"
    >
      <div
        class="loader border-t-4 border-blue-500 border-solid rounded-full w-16 h-16 animate-spin"
      ></div>
    </div>

    <div class="fixed top-0 bg-[#172554] z-20 w-full border-b">
      <div id="navbar-container"></div>
    </div>

    <!-- Book Search and Filter -->
    <div class="max-w-7xl w-full mt-28 mb-6">
      <div
        class="flex flex-col md:flex-row gap-4 items-center justify-between bg-gray-800 p-4 rounded-lg"
      >
        <div class="relative w-full md:w-96">
          <input
            type="text"
            id="searchInput"
            placeholder="Search your books..."
            class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
        </div>
        <div class="flex gap-4">
          <select
            id="sortSelect"
            class="bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="title">Title A-Z</option>
          </select>
        </div>
      </div>
    </div>

    <div class="max-w-7xl w-full py-2 mb-28 rounded-lg">
      <div
        id="booksContainer"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
    </div>

    <!-- Enhanced Modal for PDF Viewer -->
    <div
      id="pdfModal"
      class="hidden fixed z-50 inset-0 bg-black bg-opacity-90 flex items-center justify-center"
    >
      <div
        class="bg-gray-800 w-full h-full rounded-lg relative shadow-lg pdf-protection"
      >
        <!-- Top Toolbar -->
        <div
          class="absolute top-0 left-0 right-0 bg-gray-800 p-3 flex justify-between items-center z-20 border-b border-gray-700"
        >
          <div class="flex items-center space-x-4">
            <button
              id="zoomOut"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Zoom Out"
            >
              <i class="fas fa-search-minus"></i>
            </button>
            <button
              id="zoomIn"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Zoom In"
            >
              <i class="fas fa-search-plus"></i>
            </button>
            <button
              id="rotateLeft"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Rotate Left"
            >
              <i class="fas fa-undo"></i>
            </button>
            <button
              id="rotateRight"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Rotate Right"
            >
              <i class="fas fa-redo"></i>
            </button>
            <div class="h-6 w-px bg-gray-600"></div>
            
            <!-- Search functionality -->
            <div class="flex items-center space-x-2">
              <button
                id="searchBtn"
                class="text-white hover:text-blue-400 transition tooltip"
                title="Search in PDF (Ctrl+F)"
              >
                <i class="fas fa-search"></i>
              </button>
              <div id="searchContainer" class="hidden flex items-center space-x-2">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search in PDF..."
                  class="bg-gray-700 text-white px-3 py-1 rounded text-sm w-48 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                  id="searchPrev"
                  class="text-white hover:text-blue-400 transition"
                  title="Previous (Shift+F3)"
                >
                  <i class="fas fa-chevron-up"></i>
                </button>
                <button
                  id="searchNext"
                  class="text-white hover:text-blue-400 transition"
                  title="Next (F3)"
                >
                  <i class="fas fa-chevron-down"></i>
                </button>
                <span id="searchResults" class="text-gray-400 text-sm"></span>
                <button
                  id="closeSearch"
                  class="text-white hover:text-red-400 transition"
                  title="Close Search (Esc)"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
        
            
            <!-- Goto page functionality -->
         
            
          
            
            <!-- Additional PDF features -->
            <button
              id="toggleSidebar"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Toggle Sidebar"
            >
              <i class="fas fa-bars"></i>
            </button>
            <button
              id="toggleThumbnails"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Toggle Thumbnails"
            >
              <i class="fas fa-th"></i>
            </button>
            <button
              id="toggleOutline"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Toggle Outline"
            >
              <i class="fas fa-list"></i>
            </button>
            <button
              id="toggleReviews"
              class="text-white hover:text-blue-400 transition tooltip flex items-center gap-2"
              title="Show Reviews"
            >
              <i class="fas fa-comments"></i>
              <span class="text-sm">Reviews</span>
            </button>
          </div>
          <div class="flex items-center gap-4">
            <button
              id="downloadBtn"
              class="text-white hover:text-green-400 transition tooltip"
              title="Download PDF"
            >
              <i class="fas fa-download"></i>
            </button>
            <button
              id="printBtn"
              class="text-white hover:text-blue-400 transition tooltip"
              title="Print PDF"
            >
              <i class="fas fa-print"></i>
            </button>
            <button
              id="closeModal"
              class="text-white hover:text-red-500 transition tooltip"
              title="Close"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <div class="watermark"></div>

        <!-- Main content area with PDF and Sidebars -->
        <div class="flex h-full pt-12">
          <!-- Left Sidebar (Thumbnails/Outline) -->
          <div
            id="leftSidebar"
            class="hidden w-64 bg-gray-800 border-r border-gray-700 overflow-y-auto"
          >
            <div class="p-4">
              <!-- Thumbnails Panel -->
              <div id="thumbnailsPanel" class="space-y-2">
                <h3 class="text-lg font-semibold text-white mb-4">Thumbnails</h3>
                <div id="thumbnailsContainer" class="space-y-2">
                  <!-- Thumbnails will be loaded here -->
                </div>
              </div>
              
              <!-- Outline Panel -->
              <div id="outlinePanel" class="hidden space-y-2">
                <h3 class="text-lg font-semibold text-white mb-4">Outline</h3>
                <div id="outlineContainer" class="space-y-1">
                  <!-- Outline will be loaded here -->
                </div>
              </div>
            </div>
          </div>

          <!-- PDF Viewer -->
          <div id="pdfContainer" class="flex-1 relative">
            <div id="pdfViewer" class="w-full h-full"></div>
            
            <!-- PDF.js Viewer Container -->
            <div id="pdfjsViewer" class="w-full h-full hidden">
              <div id="pdfjsContainer" class="w-full h-full"></div>
            </div>
          </div>

          <!-- Reviews Sidebar (hidden by default) -->
          <div
            id="reviewsSidebar"
            class="hidden w-96 bg-gray-800 border-l border-gray-700 overflow-y-auto"
          >
            <div class="p-4">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Reviews</h3>
                <div class="flex items-center gap-2">
                  <span
                    class="text-yellow-400 text-lg font-bold"
                    id="averageRating"
                    >0.0</span
                  >
                  <div class="flex items-center">
                    <i class="fas fa-star text-yellow-400"></i>
                    <span class="text-gray-400 text-sm ml-1" id="totalReviews"
                      >(0)</span
                    >
                  </div>
                </div>
              </div>

              <!-- Add Review Button -->
              <button
                id="writeReviewBtn"
                class="w-full bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition mb-4"
              >
                <i class="fas fa-pen mr-2"></i>Write a Review
              </button>

              <!-- Review Form (hidden by default) -->
              <div id="reviewForm" class="hidden mb-4">
                <div class="bg-gray-700 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="rating">
                      <i
                        class="fas fa-star text-gray-400 cursor-pointer hover:text-yellow-400"
                        data-rating="1"
                      ></i>
                      <i
                        class="fas fa-star text-gray-400 cursor-pointer hover:text-yellow-400"
                        data-rating="2"
                      ></i>
                      <i
                        class="fas fa-star text-gray-400 cursor-pointer hover:text-yellow-400"
                        data-rating="3"
                      ></i>
                      <i
                        class="fas fa-star text-gray-400 cursor-pointer hover:text-yellow-400"
                        data-rating="4"
                      ></i>
                      <i
                        class="fas fa-star text-gray-400 cursor-pointer hover:text-yellow-400"
                        data-rating="5"
                      ></i>
                    </div>
                    <span class="text-sm text-gray-400" id="ratingText"
                      >Select rating</span
                    >
                  </div>
                  <textarea
                    id="reviewText"
                    class="w-full bg-gray-600 text-white rounded-lg p-3 mb-3"
                    rows="4"
                    placeholder="Share your thoughts about this book..."
                  ></textarea>
                  <div class="flex justify-end gap-2">
                    <button
                      id="cancelReview"
                      class="px-3 py-1 text-gray-300 hover:text-white"
                    >
                      Cancel
                    </button>
                    <button
                      id="submitReview"
                      class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Submit
                    </button>
                  </div>
                </div>
              </div>

              <!-- Reviews List -->
              <div id="reviewsList" class="space-y-4">
                <!-- Reviews will be loaded here -->
              </div>
            </div>
          </div>
        </div>

    
   
      </div>
    </div>

    <style>
      .tooltip:hover::after {
        content: attr(title);
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        transform: translateY(24px);
      }
    </style>

    <script>
      window.onload = () => {
        const firebaseConfig = {
          apiKey: "AIzaSyCtaftgrL4p4wqNC2w211mUi8amkjw2kzM",
          authDomain: "profstudymate-6d0fc.firebaseapp.com",
          projectId: "profstudymate",
          storageBucket: "profstudymate.appspot.com",
          messagingSenderId: "141453158869",
          appId: "1:141453158869:web:d4ded426a90e9937e2f55c",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let allBooks = [];

        // Initialize UI elements
        const pdfModal = document.getElementById("pdfModal");
        const closeModal = document.getElementById("closeModal");
        const searchInput = document.getElementById("searchInput");
        const sortSelect = document.getElementById("sortSelect");
        const zoomIn = document.getElementById("zoomIn");
        const zoomOut = document.getElementById("zoomOut");

        // Add event listeners for search and sort
        searchInput.addEventListener("input", filterBooks);
        sortSelect.addEventListener("change", filterBooks);

        function filterBooks() {
          const searchTerm = searchInput.value.toLowerCase();
          const sortOption = sortSelect.value;

          let filteredBooks = allBooks.filter(
            (book) =>
              book.title.toLowerCase().includes(searchTerm) ||
              book.description.toLowerCase().includes(searchTerm)
          );

          // Apply sorting
          filteredBooks.sort((a, b) => {
            switch (sortOption) {
              case "newest":
                return b.timestamp - a.timestamp;
              case "oldest":
                return a.timestamp - b.timestamp;
              case "title":
                return a.title.localeCompare(b.title);
              default:
                return 0;
            }
          });

          renderBooks(filteredBooks);
        }

        function renderBooks(books) {
          const booksContainer = document.getElementById("booksContainer");
          booksContainer.innerHTML = "";

          books.forEach((book) => {
            const bookCard = createBookCard(book);
            booksContainer.appendChild(bookCard);
          });
        }

        function createBookCard(book) {
          const { title, description, image_url, pdf_url } = book;
          // Update Google Drive URL handling
          const fileIdMatch = pdf_url.match(/\/d\/([^/]+)/);
          const fileId = fileIdMatch ? fileIdMatch[1] : null;
const fileId1 =book.id
          const bookCard = document.createElement("div");
          bookCard.className =
            "bg-gray-800 rounded-xl overflow-hidden shadow-lg transform transition duration-300 hover:scale-105 hover:shadow-blue-500/20 border border-gray-700";
          bookCard.innerHTML = `
            <div class="relative group">
              <img src="${image_url}" alt="${title}" class="w-full h-48 object-cover transition duration-300 group-hover:opacity-75">
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </div>
            <div class="p-6 space-y-4">
              <h2 class="text-xl font-bold text-white line-clamp-2">${title}</h2>
              <p class="text-gray-400 text-sm line-clamp-3">${description}</p>
              <button class="w-full flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300"
                onclick="openPdf('${pdf_url}', '${title}', '${fileId}', '${fileId1}')">
                <i class="fas fa-book-reader"></i>
                <span>Read Book</span>
              </button>
            </div>
          `;
          return bookCard;
        }

        firebase.auth().onAuthStateChanged(async (user) => {
          const booksContainer = document.getElementById("booksContainer");
          if (!user) {
            booksContainer.innerHTML =
              "<p class='text-center text-red-500 font-semibold'>Please log in to view your books.</p>";
            return;
          }

          try {
            const myBooksSnapshot = await db
              .collection("Mybooks")
              .doc(user.uid)
              .collection("books")
              .get();

            if (myBooksSnapshot.empty) {
              booksContainer.innerHTML =
                "<p class='text-center text-gray-400 font-semibold'>No books found.</p>";
              return;
            }

            const bookPromises = myBooksSnapshot.docs.map(async (doc) => {
              const bookDoc = await db.collection("books").doc(doc.id).get();
              return bookDoc.exists
                ? {
                    id: doc.id,
                    ...bookDoc.data(),
                    timestamp: doc.data().timestamp?.toMillis() || 0,
                  }
                : null;
            });

            allBooks = (await Promise.all(bookPromises)).filter(
              (book) => book !== null
            );
            filterBooks(); // Initial render with all books
            document.getElementById("loadingScreen").classList.add("hidden");
          } catch (error) {
            console.error("Error fetching books:", error);
            booksContainer.innerHTML =
              "<p class='text-center text-red-500 font-semibold'>Failed to load books.</p>";
          }
        });

        // Enhanced PDF viewer functionality
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;
        let rotation = 0;
        let pdfViewer = null;
        let pdfLinkService = null;
        let pdfFindController = null;
        let pdfOutlineViewer = null;
        let pdfThumbnailViewer = null;
        let currentPdfUrl = null;

        // PDF viewer state
        let isSidebarOpen = false;
        let isThumbnailsVisible = false;
        let isOutlineVisible = false;
        let isReviewsVisible = false;

        // Enhanced renderPage function
        async function renderPage(num) {
          if (!pdfDoc) return;
          
          const page = await pdfDoc.getPage(num);
          const viewport = page.getViewport({ scale, rotation });

          // Create canvas for this page
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          // Create container for the page
          const pageContainer = document.createElement("div");
          pageContainer.className = "page-container";
          pageContainer.setAttribute("data-page", num);
          pageContainer.appendChild(canvas);

          // Add watermark to each page
          const watermark = document.createElement("div");
          watermark.className = "watermark";
          watermark.style.position = "absolute";
          watermark.style.opacity = "0.1";
          watermark.textContent = `${
            firebase.auth().currentUser.email
          } - ${new Date().toLocaleDateString()}`;
          pageContainer.appendChild(watermark);

          // Render PDF page
          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };

          await page.render(renderContext);
          
          // Add search highlighting if search is active
          if (searchText && searchResults.length > 0) {
            await addSearchHighlights(page, pageContainer, viewport);
          }
          
          return pageContainer;
        }

        // Initialize comprehensive PDF viewer
        async function initializePdfViewer(pdfUrl) {
          try {
            currentPdfUrl = pdfUrl;
            
            // Load PDF document
            const loadingTask = pdfjsLib.getDocument({
              url: pdfUrl,
              cMapUrl: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/",
              cMapPacked: true,
            });

            pdfDoc = await loadingTask.promise;
            
            // Initialize PDF.js viewer components
            await initializePdfJsViewer();
            
            // Load thumbnails
            await loadThumbnails();
            
            // Load outline
            await loadOutline();
            
            // Update UI
            document.getElementById("totalPages").textContent = pdfDoc.numPages;
            document.getElementById("currentPage").textContent = "1";
            
            // Setup event listeners
            setupPdfControls();
            
            console.log("PDF viewer initialized successfully");
            
              } catch (error) {
            console.error("Error initializing PDF viewer:", error);
            throw error;
          }
        }

        // Initialize PDF.js viewer components
        async function initializePdfJsViewer() {
          const container = document.getElementById("pdfjsContainer");
          
          // Create PDF.js viewer components
          pdfLinkService = new pdfjsLib.PDFLinkService();
          pdfFindController = new pdfjsLib.PDFFindController({
            linkService: pdfLinkService,
          });
          
          // Create viewer
          pdfViewer = new pdfjsLib.PDFViewer({
            container: container,
            linkService: pdfLinkService,
            findController: pdfFindController,
            textLayerMode: 2, // Enable text layer
            renderInteractiveForms: true,
          });
          
          // Link the components
          pdfLinkService.setViewer(pdfViewer);
          pdfFindController.setViewer(pdfViewer);
          
          // Load the document
          await pdfViewer.setDocument(pdfDoc);
          
          // Show the viewer
          document.getElementById("pdfjsViewer").classList.remove("hidden");
          document.getElementById("pdfViewer").classList.add("hidden");
        }

        // Load thumbnails
        async function loadThumbnails() {
          const container = document.getElementById("thumbnailsContainer");
          container.innerHTML = "";
          
          const thumbnailScale = 0.2;
          
          for (let pageNum = 1; pageNum <= Math.min(pdfDoc.numPages, 50); pageNum++) {
            try {
              const page = await pdfDoc.getPage(pageNum);
              const viewport = page.getViewport({ scale: thumbnailScale });
              
              const canvas = document.createElement("canvas");
              const context = canvas.getContext("2d");
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              
              const renderContext = {
                canvasContext: context,
                viewport: viewport,
              };
              
              await page.render(renderContext);
              
              const thumbnailItem = document.createElement("div");
              thumbnailItem.className = "thumbnail-item relative";
              thumbnailItem.setAttribute("data-page", pageNum);
              
              thumbnailItem.innerHTML = `
                <img src="${canvas.toDataURL()}" alt="Page ${pageNum}">
                <div class="page-number">${pageNum}</div>
              `;
              
              thumbnailItem.onclick = () => {
                goToPage(pageNum);
                updateActiveThumbnail(pageNum);
              };
              
              container.appendChild(thumbnailItem);
            } catch (error) {
              console.error(`Error loading thumbnail for page ${pageNum}:`, error);
            }
          }
        }

        // Load outline
        async function loadOutline() {
          const container = document.getElementById("outlineContainer");
          container.innerHTML = "";
          
          try {
            const outline = await pdfDoc.getOutline();
            
            if (outline && outline.length > 0) {
              outline.forEach(item => {
                const outlineItem = createOutlineItem(item, 1);
                container.appendChild(outlineItem);
              });
            } else {
              container.innerHTML = '<p class="text-gray-400 text-sm">No outline available</p>';
            }
          } catch (error) {
            console.error("Error loading outline:", error);
            container.innerHTML = '<p class="text-gray-400 text-sm">Error loading outline</p>';
          }
        }

        // Create outline item
        function createOutlineItem(item, level) {
          const div = document.createElement("div");
          div.className = `outline-item outline-level-${level}`;
          div.textContent = item.title;
          
          div.onclick = async () => {
            try {
              const dest = await pdfDoc.getDestination(item.dest);
              const page = await pdfDoc.getPageIndex(dest[0]);
              goToPage(page + 1);
              updateActiveOutlineItem(div);
            } catch (error) {
              console.error("Error navigating to outline item:", error);
            }
          };
          
          if (item.items && item.items.length > 0) {
            item.items.forEach(subItem => {
              const subDiv = createOutlineItem(subItem, level + 1);
              div.appendChild(subDiv);
            });
          }
          
          return div;
        }

        // Update active thumbnail
        function updateActiveThumbnail(pageNum) {
          document.querySelectorAll('.thumbnail-item').forEach(item => {
            item.classList.remove('active');
          });
          
          const activeThumbnail = document.querySelector(`[data-page="${pageNum}"]`);
          if (activeThumbnail) {
            activeThumbnail.classList.add('active');
            activeThumbnail.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }

        // Update active outline item
        function updateActiveOutlineItem(activeItem) {
          document.querySelectorAll('.outline-item').forEach(item => {
            item.classList.remove('active');
          });
          
          if (activeItem) {
            activeItem.classList.add('active');
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }

        // Enhanced goToPage function
        function goToPage(pageNumber) {
          if (!pdfDoc) {
            console.log("PDF not loaded yet");
            return;
          }
          
          if (pageNumber < 1 || pageNumber > pdfDoc.numPages) {
            console.log(`Invalid page number: ${pageNumber}`);
            return; 
          }
          
          console.log(`Going to page ${pageNumber}`);
          currentPage = pageNumber;
          
          if (pdfViewer) {
            pdfViewer.currentPageNumber = pageNumber;
          }
          
          // Update current page display if it exists
          const currentPageElement = document.getElementById("currentPage");
          if (currentPageElement) {
            currentPageElement.textContent = pageNumber;
          }
          
          // Update active thumbnail
          updateActiveThumbnail(pageNumber);
        }

        // Download PDF
        async function downloadPdf() {
          if (!currentPdfUrl) return;
          
          try {
            const response = await fetch(currentPdfUrl);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `document-${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
                    } catch (error) {
            console.error("Error downloading PDF:", error);
            alert("Error downloading PDF. Please try again.");
          }
        }

        // Print PDF
        function printPdf() {
          if (pdfViewer) {
            pdfViewer.print();
          } else {
            window.print();
          }
        }

        // Toggle sidebar
        function toggleSidebar() {
          const sidebar = document.getElementById("leftSidebar");
          isSidebarOpen = !isSidebarOpen;
          
          if (isSidebarOpen) {
            sidebar.classList.remove("hidden");
          } else {
            sidebar.classList.add("hidden");
          }
        }

        // Toggle thumbnails
        function toggleThumbnails() {
          const thumbnailsPanel = document.getElementById("thumbnailsPanel");
          const outlinePanel = document.getElementById("outlinePanel");
          
          isThumbnailsVisible = !isThumbnailsVisible;
          isOutlineVisible = false;
          
          if (isThumbnailsVisible) {
            thumbnailsPanel.classList.remove("hidden");
            outlinePanel.classList.add("hidden");
            toggleSidebar();
          } else {
            thumbnailsPanel.classList.add("hidden");
            if (!isOutlineVisible) {
              toggleSidebar();
            }
          }
        }

        // Toggle outline
        function toggleOutline() {
          const thumbnailsPanel = document.getElementById("thumbnailsPanel");
          const outlinePanel = document.getElementById("outlinePanel");
          
          isOutlineVisible = !isOutlineVisible;
          isThumbnailsVisible = false;
          
          if (isOutlineVisible) {
            outlinePanel.classList.remove("hidden");
            thumbnailsPanel.classList.add("hidden");
            toggleSidebar();
          } else {
            outlinePanel.classList.add("hidden");
            if (!isThumbnailsVisible) {
              toggleSidebar();
            }
          }
        }

        // Toggle reviews
        function toggleReviews() {
          const reviewsSidebar = document.getElementById("reviewsSidebar");
          isReviewsVisible = !isReviewsVisible;
          
          if (isReviewsVisible) {
            reviewsSidebar.classList.remove("hidden");
            loadReviews();
          } else {
            reviewsSidebar.classList.add("hidden");
          }
        }

        // Search functionality variables
        let searchResults = [];
        let currentSearchIndex = -1;
        let searchText = '';

        // Enhanced setupPdfControls function with all new features
        function setupPdfControls() {
          console.log("Setting up PDF controls...");
          
          // Existing search and goto page functionality
          const searchBtn = document.getElementById("searchBtn");
          const closeSearch = document.getElementById("closeSearch");
          const searchInput = document.getElementById("searchInput");
          const searchNext = document.getElementById("searchNext");
          const searchPrev = document.getElementById("searchPrev");
          
          console.log("Search elements found:", { searchBtn, closeSearch, searchInput, searchNext, searchPrev });
          
          if (searchBtn) {
            searchBtn.onclick = handleSearchButtonClick;
          }

          if (closeSearch) {
            closeSearch.onclick = () => {
              console.log("Close search clicked");
              document.getElementById("searchContainer").classList.add("hidden");
              clearSearchHighlights();
            };
          }

          if (searchInput) {
            searchInput.addEventListener("input", handleSearchInput);
          }

          if (searchNext) {
            searchNext.onclick = () => {
              console.log("Search next clicked");
              if (searchResults.length > 0) {
                currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
                highlightCurrentSearch();
              }
            };
          }

          if (searchPrev) {
            searchPrev.onclick = () => {
              console.log("Search prev clicked");
              if (searchResults.length > 0) {
                currentSearchIndex = currentSearchIndex <= 0 ? searchResults.length - 1 : currentSearchIndex - 1;
                highlightCurrentSearch();
              }
            };
          }

          // Goto page functionality
          const gotoPageBtn = document.getElementById("gotoPageBtn");
          const closeGotoPage = document.getElementById("closeGotoPage");
          const gotoPageGo = document.getElementById("gotoPageGo");
          const gotoPageInput = document.getElementById("gotoPageInput");
          
          console.log("Goto page elements found:", { gotoPageBtn, closeGotoPage, gotoPageGo, gotoPageInput });
          
          if (gotoPageBtn) {
            gotoPageBtn.onclick = () => {
              console.log("Goto page button clicked");
              const gotoPageContainer = document.getElementById("gotoPageContainer");
              const searchContainer = document.getElementById("searchContainer");
              
              gotoPageContainer.classList.toggle("hidden");
              searchContainer.classList.add("hidden");
              
              if (!gotoPageContainer.classList.contains("hidden")) {
                document.getElementById("gotoPageInput").focus();
              }
            };
          }

          if (closeGotoPage) {
            closeGotoPage.onclick = () => {
              console.log("Close goto page clicked");
              document.getElementById("gotoPageContainer").classList.add("hidden");
            };
          }

          if (gotoPageGo) {
            gotoPageGo.onclick = () => {
              console.log("Goto page go clicked");
              const pageInput = document.getElementById("gotoPageInput");
              const pageNumber = parseInt(pageInput.value);
              
              if (pageNumber && pageNumber > 0 && pdfDoc && pageNumber <= pdfDoc.numPages) {
                goToPage(pageNumber);
                pageInput.value = '';
                document.getElementById("gotoPageContainer").classList.add("hidden");
              } else if (pageNumber && pageNumber > 0) {
                alert(`Please enter a valid page number between 1 and ${pdfDoc ? pdfDoc.numPages : 'unknown'}`);
              } else {
                alert("Please enter a valid page number");
              }
            };
          }

          if (gotoPageInput) {
            gotoPageInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                document.getElementById("gotoPageGo").click();
              }
            });
          }

          // New PDF features
          const toggleSidebarBtn = document.getElementById("toggleSidebar");
          const toggleThumbnailsBtn = document.getElementById("toggleThumbnails");
          const toggleOutlineBtn = document.getElementById("toggleOutline");
          const toggleReviewsBtn = document.getElementById("toggleReviews");
          const downloadBtn = document.getElementById("downloadBtn");
          const printBtn = document.getElementById("printBtn");
          const closeModalBtn = document.getElementById("closeModal");
          const zoomInBtn = document.getElementById("zoomIn");
          const zoomOutBtn = document.getElementById("zoomOut");
          const rotateLeftBtn = document.getElementById("rotateLeft");
          const rotateRightBtn = document.getElementById("rotateRight");

          console.log("PDF control elements found:", {
            toggleSidebarBtn, toggleThumbnailsBtn, toggleOutlineBtn, toggleReviewsBtn,
            downloadBtn, printBtn, closeModalBtn, zoomInBtn, zoomOutBtn, rotateLeftBtn, rotateRightBtn
          });

          if (toggleSidebarBtn) {
            toggleSidebarBtn.onclick = () => {
              console.log("Toggle sidebar clicked");
              toggleSidebar();
            };
          }

          if (toggleThumbnailsBtn) {
            toggleThumbnailsBtn.onclick = () => {
              console.log("Toggle thumbnails clicked");
              toggleThumbnails();
            };
          }

          if (toggleOutlineBtn) {
            toggleOutlineBtn.onclick = () => {
              console.log("Toggle outline clicked");
              toggleOutline();
            };
          }

          if (toggleReviewsBtn) {
            toggleReviewsBtn.onclick = () => {
              console.log("Toggle reviews clicked");
              toggleReviews();
            };
          }

          if (downloadBtn) {
            downloadBtn.onclick = () => {
              console.log("Download clicked");
              downloadPdf();
            };
          }

          if (printBtn) {
            printBtn.onclick = () => {
              console.log("Print clicked");
              printPdf();
            };
          }

          if (closeModalBtn) {
            closeModalBtn.onclick = () => {
              console.log("Close modal clicked");
              const pdfModal = document.getElementById("pdfModal");
              const viewer = document.getElementById("pdfViewer");
          pdfModal.classList.add("hidden");
          viewer.innerHTML = "";
              document.getElementById("pdfjsViewer").classList.add("hidden");
          pdfDoc = null;
              pdfViewer = null;
            };
          }

          if (zoomInBtn) {
            zoomInBtn.onclick = () => {
              console.log("Zoom in clicked");
              const newScale = scale * 1.2;
              
              // Limit maximum zoom to 3x
              if (newScale <= 3) {
                scale = newScale;
                if (pdfViewer) {
                  // For PDF.js viewer
                  pdfViewer.currentScale = scale;
                } else {
                  // For iframe PDFs, try to zoom the iframe
                  const iframe = document.querySelector('#pdfViewer iframe');
                  if (iframe) {
                    // Apply CSS transform to zoom the iframe
                    iframe.style.transform = `scale(${scale})`;
                    iframe.style.transformOrigin = 'top left';
                    
                    // Add some visual feedback
                    showZoomFeedback(`Zoom: ${Math.round(scale * 100)}%`);
                  }
                }
              } else {
                showZoomFeedback("Maximum zoom reached");
              }
            };
          }

          if (zoomOutBtn) {
            zoomOutBtn.onclick = () => {
              console.log("Zoom out clicked");
              const newScale = scale / 1.2;
              
              // Limit minimum zoom to 0.5x
              if (newScale >= 0.5) {
                scale = newScale;
                if (pdfViewer) {
                  // For PDF.js viewer
                  pdfViewer.currentScale = scale;
                } else {
                  // For iframe PDFs, try to zoom the iframe
                  const iframe = document.querySelector('#pdfViewer iframe');
                  if (iframe) {
                    // Apply CSS transform to zoom the iframe
                    iframe.style.transform = `scale(${scale})`;
                    iframe.style.transformOrigin = 'top left';
                    
                    // Add some visual feedback
                    showZoomFeedback(`Zoom: ${Math.round(scale * 100)}%`);
                  }
                }
              } else {
                showZoomFeedback("Minimum zoom reached");
              }
            };
          }

          // Add double-click to reset zoom
          const pdfContainer = document.getElementById("pdfContainer");
          if (pdfContainer) {
            pdfContainer.addEventListener("dblclick", () => {
              resetZoom();
            });
          }

          if (rotateLeftBtn) {
            rotateLeftBtn.onclick = () => {
              console.log("Rotate left clicked");
              rotation -= 90;
              if (pdfViewer) {
                pdfViewer.pagesRotation = rotation;
              }
            };
          }

          if (rotateRightBtn) {
            rotateRightBtn.onclick = () => {
              console.log("Rotate right clicked");
              rotation += 90;
              if (pdfViewer) {
                pdfViewer.pagesRotation = rotation;
              }
            };
          }
          
          console.log("PDF controls setup complete");
        }

        // Reset zoom function
        function resetZoom() {
          console.log("Resetting zoom");
          scale = 1.5; // Reset to default scale
          
          if (pdfViewer) {
            // For PDF.js viewer
            pdfViewer.currentScale = scale;
          } else {
            // For iframe PDFs, reset the iframe zoom
            const iframe = document.querySelector('#pdfViewer iframe');
            if (iframe) {
              iframe.style.transform = `scale(${scale})`;
              iframe.style.transformOrigin = 'top left';
            }
          }
          
          showZoomFeedback(`Zoom: ${Math.round(scale * 100)}%`);
        }

        // Show zoom feedback
        function showZoomFeedback(message) {
          // Remove existing feedback
          const existingFeedback = document.getElementById("zoomFeedback");
          if (existingFeedback) {
            existingFeedback.remove();
          }
          
          // Create new feedback element
          const feedback = document.createElement("div");
          feedback.id = "zoomFeedback";
          feedback.className = "fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300";
          feedback.textContent = message;
          
          document.body.appendChild(feedback);
          
          // Remove after 2 seconds
          setTimeout(() => {
            if (feedback.parentNode) {
              feedback.style.opacity = "0";
              setTimeout(() => {
                if (feedback.parentNode) {
                  feedback.remove();
                }
              }, 300);
            }
          }, 2000);
        }

        // Enhanced search input handler
        function handleSearchInput(e) {
          searchText = e.target.value;
          if (searchText.length > 0) {
            if (pdfDoc) {
              // For PDF.js viewer, perform full search
              performSearch(searchText);
            } else {
              // For iframe PDFs, show browser search instructions
              const resultsElement = document.getElementById("searchResults");
              if (resultsElement) {
                resultsElement.textContent = "Use Ctrl+F to search in browser";
              }
              
              // Show a helpful tooltip or message
              showSearchHelp();
            }
          } else {
            clearSearchHighlights();
            hideSearchHelp();
          }
        }

        // Show search help for iframe PDFs
        function showSearchHelp() {
          // Remove existing help message
          hideSearchHelp();
          
          const searchContainer = document.getElementById("searchContainer");
          if (searchContainer) {
            const helpDiv = document.createElement("div");
            helpDiv.id = "searchHelp";
            helpDiv.className = "absolute top-full left-0 mt-2 bg-blue-600 text-white p-3 rounded-lg text-sm z-50 max-w-xs";
            helpDiv.innerHTML = `
              <div class="flex items-start gap-2">
                <i class="fas fa-info-circle mt-0.5"></i>
                <div>
                  <p class="font-semibold mb-1">Search in PDF</p>
                  <p class="text-xs opacity-90">For this PDF type, use your browser's search:</p>
                  <ul class="text-xs opacity-90 mt-1 space-y-1">
                    <li> Press <kbd class="bg-blue-700 px-1 rounded">Ctrl+F</kbd> (Windows/Linux)</li>
                    <li> Press <kbd class="bg-blue-700 px-1 rounded">Cmd+F</kbd> (Mac)</li>
                    <li> Type your search term</li>
                  </ul>
                </div>
              </div>
            `;
            searchContainer.appendChild(helpDiv);
          }
        }

        // Hide search help
        function hideSearchHelp() {
          const helpDiv = document.getElementById("searchHelp");
          if (helpDiv) {
            helpDiv.remove();
          }
        }

        // Enhanced search button click handler
        function handleSearchButtonClick() {
          const searchContainer = document.getElementById("searchContainer");
          const gotoPageContainer = document.getElementById("gotoPageContainer");
          
          searchContainer.classList.toggle("hidden");
          gotoPageContainer.classList.add("hidden");
          
          if (!searchContainer.classList.contains("hidden")) {
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
              searchInput.focus();
              
              // If it's an iframe PDF, show help immediately
              if (!pdfDoc) {
                setTimeout(() => {
                  showSearchHelp();
                }, 100);
              }
            }
          } else {
            hideSearchHelp();
          }
        }

        // Search functions
        async function performSearch(searchTerm) {
          if (!pdfDoc) {
            console.log("PDF not loaded yet - using iframe search");
            // For iframe PDFs, we can't search the content directly
            // Show a message to the user
            const resultsElement = document.getElementById("searchResults");
            if (resultsElement) {
              resultsElement.textContent = "Search not available for this PDF type";
            }
            return;
          }
          
          console.log("Performing search for:", searchTerm);
          clearSearchHighlights();
          searchResults = [];
          currentSearchIndex = -1;
          
          try {
            // Search through all pages
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
              console.log(`Searching page ${pageNum}`);
              const page = await pdfDoc.getPage(pageNum);
              const textContent = await page.getTextContent();
              
              let pageText = '';
              textContent.items.forEach(item => {
                pageText += item.str + ' ';
              });
              
              // Find all occurrences of search term
              const regex = new RegExp(searchTerm, 'gi');
              let match;
              while ((match = regex.exec(pageText)) !== null) {
                searchResults.push({
                  page: pageNum,
                  index: match.index,
                  text: match[0]
                });
              }
            }
            
            console.log(`Found ${searchResults.length} results`);
            updateSearchResults();
            
            if (searchResults.length > 0) {
              currentSearchIndex = 0;
              highlightCurrentSearch();
            }
          } catch (error) {
            console.error("Error performing search:", error);
            const resultsElement = document.getElementById("searchResults");
            if (resultsElement) {
              resultsElement.textContent = "Search error occurred";
            }
          }
        }

        function updateSearchResults() {
          const resultsElement = document.getElementById("searchResults");
          if (searchResults.length > 0) {
            resultsElement.textContent = `${currentSearchIndex + 1} of ${searchResults.length}`;
          } else {
            resultsElement.textContent = "No results";
          }
        }

        function highlightCurrentSearch() {
          if (currentSearchIndex >= 0 && currentSearchIndex < searchResults.length) {
            const result = searchResults[currentSearchIndex];
            
            // Scroll to the page
            goToPage(result.page);
            
            // Highlight the current result
            setTimeout(() => {
              highlightSearchResult(result);
            }, 500);
            
            updateSearchResults();
          }
        }

        function highlightSearchResult(result) {
          // Remove previous active highlights
          document.querySelectorAll('.search-highlight.active').forEach(el => {
            el.classList.remove('active');
          });
          
          // Add active highlight to current result
          const highlights = document.querySelectorAll('.search-highlight');
          if (highlights.length > 0) {
            highlights[currentSearchIndex % highlights.length].classList.add('active');
          }
        }

        function clearSearchHighlights() {
          document.querySelectorAll('.search-highlight').forEach(el => {
            el.remove();
          });
          searchResults = [];
          currentSearchIndex = -1;
          const resultsElement = document.getElementById("searchResults");
          if (resultsElement) {
            resultsElement.textContent = "";
          }
        }

        // Reviews functionality
        let currentBookId = null;
        let selectedRating = 0;

        function initializeReviews(bookId) {
          if (!bookId) {
            console.error("No book ID provided for reviews");
            return;
          }

          currentBookId = bookId;
          const reviewForm = document.getElementById("reviewForm");
          const writeReviewBtn = document.getElementById("writeReviewBtn");
          const cancelReview = document.getElementById("cancelReview");
          const submitReview = document.getElementById("submitReview");
          const ratingStars = document.querySelectorAll(".rating i");
          const toggleReviews = document.getElementById("toggleReviews");
          const reviewsSidebar = document.getElementById("reviewsSidebar");

          // Toggle reviews sidebar with immediate load
          if (toggleReviews) {
          toggleReviews.onclick = () => {
            const isHidden = reviewsSidebar.classList.contains("hidden");
            reviewsSidebar.classList.toggle("hidden");
            if (isHidden) {
              loadReviews(); // Load reviews when showing the sidebar
            }
          };
          }

          // Review form controls
          if (writeReviewBtn) {
          writeReviewBtn.onclick = () => {
            reviewForm.classList.remove("hidden");
          };
          }

          if (cancelReview) {
          cancelReview.onclick = () => {
            reviewForm.classList.add("hidden");
            resetReviewForm();
          };
          }

          // Star rating functionality
          if (ratingStars.length > 0) {
          ratingStars.forEach((star, index) => {
            star.onclick = () => {
              selectedRating = index + 1;
              updateStarDisplay(selectedRating);
            };

            star.onmouseover = () => {
              updateStarDisplay(index + 1, true);
            };

            star.onmouseout = () => {
              updateStarDisplay(selectedRating);
            };
          });
          }

          // Submit review
          if (submitReview) {
          submitReview.onclick = async () => {
            if (!firebase.auth().currentUser) {
              alert("Please login to submit a review");
              return;
            }

            const reviewText = document
              .getElementById("reviewText")
              .value.trim();

            if (selectedRating === 0) {
              alert("Please select a rating");
              return;
            }

            if (reviewText.length < 10) {
              alert("Please write a review (minimum 10 characters)");
              return;
            }

            try {
              const user = firebase.auth().currentUser;

              // Create the simple review object
              const review = {
                bookId: currentBookId,
                userId: user.uid,
                rating: selectedRating,
                review: reviewText,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              };

              // Add review to new BooksReviews collection
              await db.collection("BooksReviews").add(review);

              reviewForm.classList.add("hidden");
              resetReviewForm();
              await loadReviews();
              alert("Review submitted successfully!");
            } catch (error) {
              console.error("Error submitting review:", error);
              alert("Failed to submit review. Please try again.");
            }
          };
          }
        }

        async function loadReviews() {
          if (!currentBookId) {
            console.error("No book ID available for loading reviews");
            return;
          }

          const reviewsList = document.getElementById("reviewsList");
          const averageRatingEl = document.getElementById("averageRating");
          const totalReviewsEl = document.getElementById("totalReviews");

          try {
            // Show loading state
            reviewsList.innerHTML = `
              <div class="flex justify-center items-center py-4">
                <div class="loader border-t-4 border-blue-500 border-solid rounded-full w-8 h-8 animate-spin"></div>
              </div>
            `;

            // Get reviews from BooksReviews collection
            const reviewsSnapshot = await db
              .collection("BooksReviews")
              .where("bookId", "==", currentBookId)
              .orderBy("createdAt", "desc")
              .get();

            // Calculate average rating
            let totalRatings = 0;
            let totalStars = 0;

            reviewsSnapshot.forEach((doc) => {
              const review = doc.data();
              totalRatings++;
              totalStars += review.rating;
            });

            const averageRating = totalRatings > 0 ? (totalStars / totalRatings).toFixed(1) : "0.0";

            // Update UI
            averageRatingEl.textContent = averageRating;
            totalReviewsEl.textContent = `(${totalRatings})`;

            // Render reviews
            if (totalRatings > 0) {
            reviewsList.innerHTML = reviewsSnapshot.docs
              .map((doc) => {
                const review = doc.data();
                const date = review.createdAt
                    ? new Date(review.createdAt.toDate()).toLocaleDateString()
                  : "Unknown date";

                return `
                    <div class="bg-gray-700 rounded-lg p-4">
                      <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                          <div class="flex">
                            ${Array(5)
                              .fill()
                              .map(
                                (_, i) =>
                                  `<i class="fas fa-star ${
                                    i < review.rating
                                      ? "text-yellow-400"
                                      : "text-gray-600"
                                  }"></i>`
                              )
                              .join("")}
                          </div>
                          <span class="text-sm text-gray-400">${date}</span>
                    </div>
                  </div>
                  <p class="text-gray-300 mt-2">${review.review}</p>
                </div>
              `;
              })
              .join("");
            } else {
              reviewsList.innerHTML = `
                <div class="text-center py-8">
                  <i class="fas fa-comments text-gray-500 text-4xl mb-4"></i>
                  <p class="text-gray-400">No reviews yet. Be the first to review this book!</p>
                </div>
              `;
            }
          } catch (error) {
            console.error("Error loading reviews:", error);
            reviewsList.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                <p class="text-red-500">Error loading reviews. Please try again.</p>
                <button onclick="loadReviews()" class="mt-4 text-blue-400 hover:text-blue-300">
                  <i class="fas fa-redo mr-2"></i>Retry
                </button>
              </div>
            `;
          }
        }

        function updateStarDisplay(rating, isHover = false) {
          const stars = document.querySelectorAll(".rating i");
          const ratingText = document.getElementById("ratingText");

          if (stars.length > 0) {
          stars.forEach((star, index) => {
            if (index < rating) {
              star.classList.remove("text-gray-400");
              star.classList.add("text-yellow-400");
            } else {
              star.classList.remove("text-yellow-400");
              star.classList.add("text-gray-400");
            }
          });
          }

          if (ratingText && !isHover) {
            ratingText.textContent =
              rating > 0
                ? `${rating} star${rating > 1 ? "s" : ""}`
                : "Select rating";
          }
        }

        function resetReviewForm() {
          selectedRating = 0;
          updateStarDisplay(0);
          const reviewText = document.getElementById("reviewText");
          if (reviewText) {
            reviewText.value = "";
          }
        }

        // Comprehensive openPdf function
        window.openPdf = async (url, title, fileId, fileId1) => {
          try {
            const pdfModal = document.getElementById("pdfModal");
            const viewer = document.getElementById("pdfViewer");
            const reviewsSidebar = document.getElementById("reviewsSidebar");
            const container = document.getElementById("pdfContainer");
            
            // Clear previous PDF and reset state
            viewer.innerHTML = "";
            document.getElementById("pdfjsViewer").classList.add("hidden");
            viewer.classList.remove("hidden");
            pdfModal.classList.remove("hidden");
            reviewsSidebar.classList.add("hidden");
            
            // Reset sidebar states
            isSidebarOpen = false;
            isThumbnailsVisible = false;
            isOutlineVisible = false;
            isReviewsVisible = false;
            document.getElementById("leftSidebar").classList.add("hidden");
            document.getElementById("thumbnailsPanel").classList.remove("hidden");
            document.getElementById("outlinePanel").classList.add("hidden");

            // Setup PDF controls immediately
            setupPdfControls();

            // Store the current PDF information
            window.currentPdfInfo = {
              url: url,
              title: title,
              fileId: fileId,
            };

            // Show loading state
            viewer.innerHTML = `
              <div class="flex items-center justify-center w-full h-full">
                <div class="text-white text-center">
                  <div class="loader border-t-4 border-blue-500 border-solid rounded-full w-12 h-12 animate-spin mb-4 mx-auto"></div>
                  <p>Loading PDF...</p>
                </div>
              </div>
            `;

            // Initialize reviews system
            initializeReviews(fileId1);

            // Handle Google Drive URLs
            let pdfUrl = url;
            if (fileId) {
              pdfUrl = `https://drive.google.com/file/d/${fileId}/preview?usp=embed_view&rm=minimal&hl=en&embedded=true&usp=drivesdk&chrome=false&disablekb=1`;

              try {
                viewer.innerHTML = `
                  <div class="w-full h-full relative">
                    <div class="absolute inset-0 z-10" style="pointer-events: none;"></div>
                    <iframe 
                      src="${pdfUrl}"
                      class="w-full h-full"
                      style="border: none; background: #fff;"
                      sandbox="allow-scripts allow-same-origin allow-popups"
                    ></iframe>
                  </div>
                `;

                const overlay = document.createElement("div");
                overlay.className = "absolute top-0 left-0 right-0 h-[50px] z-20";
                overlay.style.background = "#525659";
                viewer.firstElementChild.appendChild(overlay);

                return;
              } catch (error) {
                console.log("Cannot embed file directly, showing alternatives");
                viewer.innerHTML = `
                  <div class="flex items-center justify-center w-full h-full">
                    <div class="text-white text-center">
                      <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                      <p>Unable to display PDF directly.</p>
                      <a href="${url}" target="_blank" class="text-blue-400 hover:text-blue-300 mt-2 block">
                        Open in new tab
                      </a>
                    </div>
                  </div>
                `;
                return;
              }
            }

            // Initialize comprehensive PDF viewer
            try {
              await initializePdfViewer(pdfUrl);
            } catch (error) {
              console.error("Error initializing PDF viewer:", error);
              viewer.innerHTML = `
                <div class="flex items-center justify-center w-full h-full">
                  <div class="text-white text-center">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>Error loading PDF. Please try again.</p>
                    <a href="${url}" target="_blank" class="text-blue-400 hover:text-blue-300 mt-2 block">
                      Open in new tab
                    </a>
                  </div>
                </div>
              `;
            }
          } catch (error) {
            console.error("Fatal error:", error);
            const viewer = document.getElementById("pdfViewer");
            if (viewer) {
              viewer.innerHTML = `
                <div class="flex items-center justify-center w-full h-full">
                  <div class="text-white text-center">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>An error occurred. Please try again.</p>
                  </div>
                </div>
              `;
            }
          }
        };
      };
    </script>
  </body>
</html>
